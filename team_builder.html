<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TGS HalÄ±saha â€“ TakÄ±m ve Ä°statistikler</title>
  <meta name="theme-color" content="#0b1530">
  <style>
    :root{ --bg1:#0b1530; --bg2:#0e223f; --panel:#111c36; --panel-2:#0f1a31;
      --accent:#27e0a5; --text:#e9f2ff; --muted:#a7bbd6; --line:#1f3557; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);
      background: radial-gradient(1200px 500px at 50% -10%, rgba(28,64,112,.55), rgba(28,64,112,0) 60%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));}
    header{position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:10px;justify-content:space-between;
      padding:14px 16px;background:linear-gradient(180deg, rgba(6,14,33,.9), rgba(6,14,33,.75));
      border-bottom:1px solid rgba(96,165,250,.18);backdrop-filter: blur(6px);}
    h1{margin:0;font-size:clamp(18px,2.6vw,22px)}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid rgba(96,165,250,.25);
      background:linear-gradient(180deg,var(--panel),var(--panel-2));padding:8px 10px;border-radius:999px;font-size:12px;color:#cfe2ff;}
    main{max-width:1200px;margin:16px auto 80px;padding:0 16px;}
    .grid{display:grid;gap:16px;grid-template-columns:1.15fr 1fr}
    @media (max-width:1050px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(160deg,#0f1d3a 0%,#0b1530 100%);border:1px solid rgba(96,165,250,.15);
      border-radius:14px;overflow:hidden;box-shadow:0 16px 32px rgba(0,0,0,.35);}
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--line);font-size:16px}
    .content{padding:14px 16px}
    .actions{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;align-items:center}
    button, select, input[type="number"]{
      padding:8px 10px;border-radius:10px;border:1px solid #274b6a;background:#0e2235;color:#cfe6ff;font-weight:600;cursor:pointer}
    button.cta{background:var(--accent);color:#031a15;border:none;box-shadow:0 10px 22px rgba(39,224,165,.35)}
    .small{font-size:12px;color:var(--muted)}
    .split3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    @media (max-width:900px){.split3{grid-template-columns:1fr}}
    .list-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .dropzone{min-height:140px;border:1px dashed #2b4c7a;border-radius:12px;padding:8px;display:grid;gap:8px;background:#0e203a}
    .item{display:grid;grid-template-columns:auto 1fr;gap:10px;padding:8px;border:1px solid var(--line);border-radius:10px;background:#0f2240}
    .item.dragging{opacity:.6}
    .thumb{width:52px;height:40px;object-fit:cover;border-radius:8px;border:1px solid var(--line)}
    .rowtop{display:flex;align-items:center;gap:8px;justify-content:space-between}
    .rowbot{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;align-items:center}
    .num{width:64px}
    .fieldwrap{display:grid;gap:14px}
    .field{position:relative;aspect-ratio:2/3;border-radius:18px;background:linear-gradient(180deg,#0e2b17,#0a1c0f);
      border:1px solid #2f5641;padding:10px}
    .field::before,.field::after{content:"";position:absolute;left:50%;transform:translateX(-50%);border:2px solid rgba(255,255,255,.25);}
    .field::before{top:8%;width:70%;height:26%;border-radius:12px}
    .field::after{bottom:8%;width:70%;height:26%;border-radius:12px}
    .circle{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:26%;height:16%;border-radius:999px;border:2px solid rgba(255,255,255,.25)}
    .field-title{display:flex;align-items:center;justify-content:space-between}
    .pos{position:absolute;translate:-50% -50%;display:grid;place-items:center;gap:4px;text-align:center}
    .badge{font-size:10px;padding:2px 6px;border-radius:999px;background:#102f23;color:#b9ffe7;border:1px solid rgba(39,224,165,.35)}
    .avatar{width:60px;height:46px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,.2)}
    .label{font-size:11px}
    .split2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:700px){.split2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1>Toprak GÃ¼bre Su HalÄ±saha â€“ TakÄ±m & MaÃ§ YÃ¶netimi</h1>
    <div class="pill">ğŸ–ï¸ SÃ¼rÃ¼kle-BÄ±rak ile Manuel TakÄ±m â€¢ ğŸ“¡ SeÃ§imler canlÄ±</div>
  </header>

  <main class="grid">
    <!-- LEFT: manual team building -->
    <section class="card">
      <h2>Kadro / TakÄ±m Kur (Manuel)</h2>
      <div class="content">
        <div class="actions">
          <label class="small">TakÄ±m boyutu (her takÄ±m):</label>
          <select id="teamSize">
            <option value="5">5</option>
            <option value="6" selected>6</option>
            <option value="7">7</option>
          </select>
          <button id="autoSplit" title="SÄ±rayla A/B">Oto-bÃ¶l A/B</button>
          <button class="cta" id="buildBtn">Sahaya YerleÅŸtir</button>
          <div style="flex:1"></div>
          <button id="newMatch">Yeni MaÃ§</button>
          <button class="cta" id="saveStats">Kaydet</button>
          <button id="exportCsv">CSV Ä°ndir</button>
        </div>

        <div class="small" id="matchMeta">Match: (oluÅŸturuluyorâ€¦)</div>
        <div class="small" id="status"></div>

        <div class="split3" style="margin-top:10px">
          <div>
            <div class="list-header"><b>Bench</b><span class="small" id="countBench"></span></div>
            <div class="dropzone" id="zone-bench" data-team="-"></div>
          </div>
          <div>
            <div class="list-header"><b>TakÄ±m A</b><span class="small" id="countA"></span></div>
            <div class="dropzone" id="zone-A" data-team="A"></div>
          </div>
          <div>
            <div class="list-header"><b>TakÄ±m B</b><span class="small" id="countB"></span></div>
            <div class="dropzone" id="zone-B" data-team="B"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT: two fields -->
    <section class="card">
      <h2>Saha YerleÅŸimi</h2>
      <div class="content fieldwrap">
        <div class="split2">
          <div>
            <div class="field-title"><b>TakÄ±m A</b><span class="small" id="hintA"></span></div>
            <div class="field" id="fieldA"><div class="circle"></div></div>
          </div>
          <div>
            <div class="field-title"><b>TakÄ±m B</b><span class="small" id="hintB"></span></div>
            <div class="field" id="fieldB"><div class="circle"></div></div>
          </div>
        </div>
        <p class="small">ğŸ¯ Oyuncuyu kartÄ±ndan **sÃ¼rÃ¼kleyip** listeler arasÄ±nda taÅŸÄ±. Karttaki **Rol / Starter / Gol / Asist** alanlarÄ± dÃ¼zenlenebilir. â€œKaydetâ€ hepsini Firestoreâ€™a yazar.</p>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCWzY5xWn1WYPCfeaQb4xqmJIy5oJnaiHk",
      authDomain: "tgshalisaha-1e266.firebaseapp.com",
      projectId: "tgshalisaha-1e266",
      storageBucket: "tgshalisaha-1e266.appspot.com",
      messagingSenderId: "829282473937",
      appId: "1:829282473937:web:bdf37a003cad53b763f2f0",
      measurementId: "G-4898506T9Z"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Players (14)
    const PLAYERS = [
      {id:"tsubasa", name:"Tsubasa Ozora", img:"images/tsubasa.jpg"},
      {id:"hyuga", name:"Kojiro Hyuga", img:"images/hyuga.jpg"},
      {id:"misaki", name:"Taro Misaki", img:"images/misaki.jpg"},
      {id:"wakabayashi", name:"Genzo Wakabayashi", img:"images/wakabayashi.jpg"},
      {id:"wakashimazu", name:"Ken Wakashimazu", img:"images/wakashimazu.jpg"},
      {id:"matsuyama", name:"Hikaru Matsuyama", img:"images/matsuyama.jpg"},
      {id:"soda", name:"Makoto Soda", img:"images/soda.jpg"},
      {id:"tachibana", name:"Kazuo Tachibana", img:"images/tachibana.jpg"},
      {id:"takasugi", name:"Shingo Takasugi", img:"images/takasugi.jpg"},
      {id:"ishizaki", name:"Ryo Ishizaki", img:"images/ishizaki.jpg"},
      {id:"jun", name:"Jun Misugi", img:"images/jun.jpg"},
      {id:"nitta", name:"Shun Nitta", img:"images/nitta.jpg"},
      {id:"kisugi", name:"Seiichiro Kisugi", img:"images/kisugi2.jpg"},
      {id:"taki",   name:"Hajime Taki",     img:"images/taki.jpg"}
    ];

    // Refs
    const teamSizeSel = document.getElementById("teamSize");
    const autoSplitBtn = document.getElementById("autoSplit");
    const buildBtn = document.getElementById("buildBtn");
    const newMatchBtn = document.getElementById("newMatch");
    const saveStatsBtn = document.getElementById("saveStats");
    const exportCsvBtn = document.getElementById("exportCsv");
    const zoneBench = document.getElementById("zone-bench");
    const zoneA = document.getElementById("zone-A");
    const zoneB = document.getElementById("zone-B");
    const countBench = document.getElementById("countBench");
    const countA = document.getElementById("countA");
    const countB = document.getElementById("countB");
    const fieldA = document.getElementById("fieldA");
    const fieldB = document.getElementById("fieldB");
    const hintA = document.getElementById("hintA");
    const hintB = document.getElementById("hintB");
    const matchMeta = document.getElementById("matchMeta");
    const statusSpan = document.getElementById("status");

    // Local stores
    const savedTeams = JSON.parse(localStorage.getItem("tg_teams") || "{}"); // {id: "A"|"B"|"-"}
    const savedRoles = JSON.parse(localStorage.getItem("tg_roles") || "{}"); // {id: "GK"/"DEF"/"MID"/"FWD"}
    const savedStats = JSON.parse(localStorage.getItem("tg_stats") || "{}"); // {id:{g,a,starter}}

    function setTeamFor(id, t){ savedTeams[id]=t; localStorage.setItem("tg_teams", JSON.stringify(savedTeams)); }
    function teamOf(id){ return savedTeams[id] ?? "-"; }
    function setRoleFor(id, r){ savedRoles[id]=r; localStorage.setItem("tg_roles", JSON.stringify(savedRoles)); }
    function roleOf(id){ return savedRoles[id] ?? "MID"; }
    function statsOf(id){ return savedStats[id] ?? {g:0,a:0,starter:false}; }
    function setStatsFor(id, s){ savedStats[id]=s; localStorage.setItem("tg_stats", JSON.stringify(savedStats)); }

    // Saha ÅŸablonlarÄ±
    const TEMPLATES = {
      5: [ {role:"GK",x:50,y:90},{role:"DEF",x:30,y:65},{role:"DEF",x:70,y:65},{role:"MID",x:40,y:40},{role:"FWD",x:60,y:25} ],
      6: [ {role:"GK",x:50,y:90},{role:"DEF",x:25,y:70},{role:"DEF",x:75,y:70},{role:"MID",x:35,y:48},{role:"MID",x:65,y:48},{role:"FWD",x:50,y:28} ],
      7: [ {role:"GK",x:50,y:90},{role:"DEF",x:20,y:70},{role:"DEF",x:50,y:70},{role:"DEF",x:80,y:70},{role:"MID",x:35,y:48},{role:"MID",x:65,y:48},{role:"FWD",x:50,y:28} ]
    };

    // Match id
    let matchId = localStorage.getItem("tg_matchId") || "";
    function ensureMatchId(){
      if(!matchId){ matchId = "m_" + Date.now(); localStorage.setItem("tg_matchId", matchId); }
      matchMeta.textContent = `Match ID: ${matchId}`;
    }
    ensureMatchId();

    let selected = []; // [{id,name,img,pickedBy,ts}]

    // Picks feed
    import { getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    onSnapshot(collection(db, "tsubasa_picks"), (snap) => {
      const map = {};
      snap.forEach(d => { map[d.id] = d.data(); });
      selected = PLAYERS.filter(p => map[p.id]?.picked)
        .map(p => ({...p, pickedBy: map[p.id].pickedBy || "", ts: map[p.id].ts || 0}))
        .sort((a,b)=>(a.ts||0)-(b.ts||0));
      statusSpan.textContent = selected.length ? `SeÃ§ili oyuncu: ${selected.length}` : "HenÃ¼z seÃ§im yok";
      renderLists();
    });

    // ----- Drag & Drop -----
    let dragId = null;
    [zoneBench, zoneA, zoneB].forEach(zone=>{
      zone.addEventListener("dragover", e=>{ e.preventDefault(); zone.style.outline="2px dashed #4fa3ff"; });
      zone.addEventListener("dragleave", ()=> zone.style.outline="");
      zone.addEventListener("drop", e=>{
        e.preventDefault(); zone.style.outline="";
        if(dragId){
          const targetTeam = zone.dataset.team;
          setTeamFor(dragId, targetTeam);
          renderLists();
          dragId = null;
        }
      });
    });

    function itemHtml(p){
      const team = teamOf(p.id);
      const st = statsOf(p.id);
      const role = roleOf(p.id);
      return `
        <div class="item" draggable="true" data-id="${p.id}">
          <img class="thumb" src="${p.img}" alt="${p.name}" onerror="this.src='https://via.placeholder.com/120x90?text=${encodeURIComponent(p.name)}'">
          <div>
            <div class="rowtop">
              <div><b>${p.name}</b> <span class="small">(${p.pickedBy || "-"})</span></div>
              <div class="small">TakÄ±m: <b>${team==="-"?"Bench":team}</b></div>
            </div>
            <div class="rowbot">
              <label class="small">Rol</label>
              <select data-ctl="role">
                <option value="GK"  ${role==="GK"?"selected":""}>GK</option>
                <option value="DEF" ${role==="DEF"?"selected":""}>DEF</option>
                <option value="MID" ${role==="MID"?"selected":""}>MID</option>
                <option value="FWD" ${role==="FWD"?"selected":""}>FWD</option>
              </select>

              <label class="small">Starter</label>
              <input data-ctl="starter" type="checkbox" ${st.starter?"checked":""} />

              <label class="small">Gol</label>
              <input data-ctl="g" class="num" type="number" min="0" max="30" value="${st.g||0}"/>

              <label class="small">Asist</label>
              <input data-ctl="a" class="num" type="number" min="0" max="30" value="${st.a||0}"/>
            </div>
          </div>
        </div>
      `;
    }

    function attachItemEvents(container){
      container.querySelectorAll(".item").forEach(el=>{
        const id = el.dataset.id;
        // drag
        el.addEventListener("dragstart", ()=>{ dragId = id; el.classList.add("dragging"); });
        el.addEventListener("dragend", ()=>{ el.classList.remove("dragging"); });

        // controls
        const roleSel = el.querySelector('[data-ctl="role"]');
        const chk = el.querySelector('[data-ctl="starter"]');
        const g = el.querySelector('[data-ctl="g"]');
        const a = el.querySelector('[data-ctl="a"]');

        roleSel.addEventListener("change", e=> setRoleFor(id, e.target.value));
        chk.addEventListener("change", e=> setStatsFor(id, {...statsOf(id), starter: e.target.checked}));
        g.addEventListener("change", e=> setStatsFor(id, {...statsOf(id), g:+e.target.value||0}));
        a.addEventListener("change", e=> setStatsFor(id, {...statsOf(id), a:+e.target.value||0}));
      });
    }

    function renderLists(){
      // ensure team defaults are '-'
      selected.forEach(p=>{ if(savedTeams[p.id]===undefined) setTeamFor(p.id, "-"); });
      const bench = selected.filter(p=>teamOf(p.id)==="-");
      const teamA = selected.filter(p=>teamOf(p.id)==="A");
      const teamB = selected.filter(p=>teamOf(p.id)==="B");

      zoneBench.innerHTML = bench.map(itemHtml).join("");
      zoneA.innerHTML = teamA.map(itemHtml).join("");
      zoneB.innerHTML = teamB.map(itemHtml).join("");

      attachItemEvents(zoneBench);
      attachItemEvents(zoneA);
      attachItemEvents(zoneB);

      countBench.textContent = `${bench.length} oyuncu`;
      countA.textContent = `${teamA.length} oyuncu`;
      countB.textContent = `${teamB.length} oyuncu`;
    }

    // Auto-split (optional)
    autoSplitBtn.addEventListener("click", ()=>{
      let toggle = true;
      selected.forEach(p=>{
        setTeamFor(p.id, toggle ? "A" : "B");
        toggle = !toggle;
      });
      renderLists();
    });

    // Saha Ã§izimi
    function renderField(fieldEl, teamPlayers, teamSize){
      fieldEl.querySelectorAll(".pos").forEach(el=>el.remove());
      const tmpl = TEMPLATES[teamSize];
      const pool = teamPlayers.slice(0, teamSize); // cap
      tmpl.forEach(slot=>{
        if(!pool.length) return;
        // role eÅŸleÅŸmesini dene
        let idx = pool.findIndex(p => roleOf(p.id)===slot.role);
        if(idx < 0) idx = 0;
        const p = pool.splice(idx,1)[0];
        const el=document.createElement("div");
        el.className="pos";
        el.style.left=slot.x+"%"; el.style.top=slot.y+"%";
        el.innerHTML = `
          <span class="badge">${slot.role}</span>
          <img class="avatar" src="${p.img}" onerror="this.src='https://via.placeholder.com/160x110?text=${encodeURIComponent(p.name)}'">
          <div class="label">${p.name}</div>`;
        fieldEl.appendChild(el);
      });
    }

    function build(){
      const size = +teamSizeSel.value;
      const teamA = selected.filter(p=>teamOf(p.id)==="A");
      const teamB = selected.filter(p=>teamOf(p.id)==="B");
      hintA.textContent = `${teamA.length} oyuncu`;
      hintB.textContent = `${teamB.length} oyuncu`;
      renderField(fieldA, teamA, size);
      renderField(fieldB, teamB, size);
    }
    buildBtn.addEventListener("click", build);

    // Yeni MaÃ§
    newMatchBtn.addEventListener("click", ()=>{
      matchId = "m_" + Date.now();
      localStorage.setItem("tg_matchId", matchId);
      // sadece istatistikleri sÄ±fÄ±rla (takÄ±m/rol kalsÄ±n istersen)
      localStorage.removeItem("tg_stats");
      Object.keys(savedStats).forEach(k=> delete savedStats[k]);
      matchMeta.textContent = `Match ID: ${matchId}`;
      alert("Yeni maÃ§ oluÅŸturuldu.");
    });

    // Kaydet â†’ Firestore
    saveStatsBtn.addEventListener("click", async ()=>{
      const teamSize = +teamSizeSel.value;
      await setDoc(doc(db, "matches", matchId), { createdAt: Date.now(), teamSize }, {merge:true});
      // her oyuncu
      const writes = selected.map(p=>{
        const data = {
          name: p.name, img: p.img,
          team: teamOf(p.id),
          role: roleOf(p.id),
          ...statsOf(p.id)
        };
        return setDoc(doc(db, "matches", matchId, "players", p.id), data, {merge:true});
      });
      await Promise.all(writes);
      alert("Kaydedildi âœ…");
    });

    // CSV
    function toCsv(rows){
      const headers = ["playerId","name","team","role","starter","goals","assists"];
      const lines = [headers.join(",")];
      rows.forEach(r=> lines.push([r.id, `"${r.name}"`, r.team, r.role, r.starter?1:0, r.g, r.a].join(",")));
      return lines.join("\n");
    }
    exportCsvBtn.addEventListener("click", ()=>{
      const rows = selected.map(p=>{
        const st = statsOf(p.id);
        return { id:p.id, name:p.name, team:teamOf(p.id), role:roleOf(p.id), starter:!!st.starter, g:st.g||0, a:st.a||0 };
      });
      const blob = new Blob([toCsv(rows)], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href=url; a.download=`match_${matchId||"current"}.csv`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
