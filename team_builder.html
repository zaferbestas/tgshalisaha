<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TGS Halƒ±saha ‚Äì Takƒ±m ve ƒ∞statistikler</title>
  <meta name="theme-color" content="#0b1530">
  <style>
    :root{
      --bg1:#0a1230; --bg2:#0d1e3f;
      --glass1:rgba(13,24,52,.6); --glass2:rgba(16,30,64,.6);
      --line:#1e335c; --muted:#9fb3d8; --text:#eaf2ff;
      --accent:#27e0a5; --accent-2:#60a5fa; --warn:#ff5a5f;
      --gk:#22d3ee; --def:#86efac; --mid:#fde68a; --fwd:#fca5a5;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 60% -20%, rgba(55,120,220,.25), transparent 60%),
        radial-gradient(900px 500px at 10% 110%, rgba(39,224,165,.12), transparent 60%),
        linear-gradient(180deg,var(--bg1),var(--bg2));
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    header{
      position:sticky; top:0; z-index:20;
      display:flex; align-items:center; gap:12px; justify-content:space-between;
      padding:12px 16px;
      background:linear-gradient(180deg, rgba(6,14,33,.88), rgba(6,14,33,.68));
      border-bottom:1px solid rgba(96,165,250,.18);
      backdrop-filter: blur(8px);
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:44px; height:44px; border-radius:50%;
      display:grid; place-items:center; font-size:22px; color:#0b1530;
      background:radial-gradient(circle at 35% 30%, #fff, #cde7ff);
      box-shadow:0 12px 26px rgba(0,0,0,.35);
      transform:rotate(-8deg);
      animation:ball 3.3s ease-in-out infinite;
    }
    @keyframes ball{0%,100%{transform:translateY(0) rotate(-8deg)} 50%{transform:translateY(-4px) rotate(8deg)}}
    h1{margin:0; font-size:clamp(18px,2.5vw,22px)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px; font-size:12px; color:#cfe2ff;
      background:linear-gradient(180deg,var(--glass1),var(--glass2));
      border:1px solid rgba(96,165,250,.25);
    }

    main{max-width:1220px; margin:16px auto 100px; padding:0 16px;}
    .grid{display:grid; gap:16px; grid-template-columns:1.2fr 1fr}
    @media (max-width:1080px){.grid{grid-template-columns:1fr}}

    .card{
      background:linear-gradient(160deg, rgba(18,30,64,.9), rgba(10,21,48,.9));
      border:1px solid rgba(96,165,250,.15); border-radius:16px; overflow:hidden;
      box-shadow:0 20px 40px rgba(0,0,0,.35);
    }
    .card h2{margin:0; padding:14px 16px; font-size:16px; border-bottom:1px solid var(--line)}
    .content{padding:14px 16px}

    .actions{display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:12px}
    button, select, input[type="number"]{
      padding:10px 12px; border-radius:12px; border:1px solid #274b6a;
      background:#0e2235; color:#cfe6ff; font-weight:700; letter-spacing:.2px; cursor:pointer;
    }
    button.cta{background:linear-gradient(180deg,var(--accent),#17c890); color:#062319; border:none; box-shadow:0 12px 26px rgba(39,224,165,.35)}
    button.ghost{background:linear-gradient(180deg,var(--glass1),var(--glass2))}
    button:active{transform:translateY(1px)}

    /* 3 lists */
    .split3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:14px}
    @media (max-width:900px){.split3{grid-template-columns:1fr}}
    .list-header{display:flex; align-items:center; justify-content:space-between; margin-bottom:6px}
    .badge{
      display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:4px 8px; border-radius:999px;
      background:linear-gradient(180deg,var(--glass1),var(--glass2)); border:1px solid rgba(96,165,250,.25); color:#cfe2ff;
    }
    .dropzone{
      min-height:160px; border:1px dashed #2b4c7a; border-radius:14px; padding:10px;
      display:grid; gap:10px; background:linear-gradient(180deg, rgba(10,26,56,.6), rgba(8,20,44,.6));
    }
    .dropzone.hover{outline:2px dashed #4fa3ff}

    /* player card */
    .item{
      display:grid; grid-template-columns:24px auto 1fr; gap:10px; align-items:center;
      padding:10px; border:1px solid var(--line); border-radius:12px;
      background:linear-gradient(180deg, #0f2244, #0d1c3a);
      box-shadow:0 10px 20px rgba(0,0,0,.25);
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .item:hover{transform:translateY(-2px); box-shadow:0 16px 32px rgba(0,0,0,.35)}
    .handle{cursor:grab; opacity:.8; user-select:none}
    .item.dragging{opacity:.65}
    .thumb{width:56px; height:42px; object-fit:cover; border-radius:8px; border:1px solid var(--line)}
    .meta{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .name{font-weight:800; letter-spacing:.2px}
    .who{font-size:12px; color:var(--muted)}
    .rowbot{display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:6px}
    .num{width:68px}

    /* role pills */
    .rolepill{
      display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:800; letter-spacing:.3px; color:#082018;
      border:1px solid rgba(255,255,255,.18);
    }
    .rp-gk { background:linear-gradient(180deg,var(--gk),#1ab4d0) }
    .rp-def{ background:linear-gradient(180deg,var(--def),#5bd487) }
    .rp-mid{ background:linear-gradient(180deg,var(--mid),#f5c84a) }
    .rp-fwd{ background:linear-gradient(180deg,var(--fwd),#f87171) }

    /* fields */
    .fieldwrap{display:grid; gap:14px}
    .split2{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    @media (max-width:720px){.split2{grid-template-columns:1fr}}
    .field-title{display:flex; align-items:center; justify-content:space-between}
    .field{
      position:relative; aspect-ratio:2/3; border-radius:18px;
      background:
        radial-gradient(400px 200px at 50% 20%, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(180deg,#0f2c18,#0b1f10);
      border:1px solid #2b6b4a; padding:10px; overflow:hidden;
    }
    .field::before,.field::after{content:""; position:absolute; left:50%; transform:translateX(-50%); border:2px solid rgba(255,255,255,.28)}
    .field::before{top:8%; width:70%; height:26%; border-radius:12px}
    .field::after{bottom:8%; width:70%; height:26%; border-radius:12px}
    .circle{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:26%; height:16%; border-radius:999px; border:2px solid rgba(255,255,255,.28)}
    .pos{position:absolute; translate:-50% -50%; display:grid; place-items:center; gap:4px; text-align:center}
    .avatar{width:60px; height:46px; object-fit:cover; border-radius:8px; border:1px solid rgba(255,255,255,.25)}
    .tag{font-size:10px; padding:2px 6px; border-radius:999px; background:rgba(0,0,0,.32); border:1px solid rgba(255,255,255,.18); color:#eafffb}

    /* sticky bottom bar for mobile actions */
    .dock{
      position:fixed; left:0; right:0; bottom:0; z-index:30;
      display:flex; gap:10px; padding:10px 12px; justify-content:center; flex-wrap:wrap;
      background:linear-gradient(180deg, rgba(6,14,33,.75), rgba(6,14,33,.9));
      border-top:1px solid rgba(96,165,250,.18); backdrop-filter: blur(6px);
    }

    /* toast */
    .toast{
      position:fixed; right:14px; bottom:74px; z-index:40;
      background:#0d2a1f; color:#b9ffe7; border:1px solid rgba(39,224,165,.35);
      border-radius:12px; padding:10px 12px; font-size:14px; box-shadow:0 12px 24px rgba(0,0,0,.35);
      display:none;
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">‚öΩ</div>
      <div>
        <h1>Toprak G√ºbre Su Halƒ±saha ‚Äì Takƒ±m & Ma√ß Y√∂netimi</h1>
        <div class="pill">üñêÔ∏è S√ºr√ºkle-Bƒ±rak ‚Ä¢ ‚úçÔ∏è Rol & ƒ∞statistik ‚Ä¢ ‚òÅÔ∏è Firestore</div>
      </div>
    </div>
  </header>

  <main class="grid">
    <!-- LEFT -->
    <section class="card">
      <h2>Kadro / Takƒ±m Kur</h2>
      <div class="content">
        <div class="actions">
          <label class="pill">Takƒ±m boyutu
            <select id="teamSize">
              <option value="5">5</option>
              <option value="6" selected>6</option>
              <option value="7">7</option>
            </select>
          </label>
          <button class="ghost" id="autoSplit" title="Sƒ±rayla A/B">Oto-b√∂l A/B</button>
          <span id="status" class="pill">Se√ßim okunuyor‚Ä¶</span>
          <span id="matchMeta" class="pill">Match: ‚Ä¶</span>
        </div>

        <div class="split3" style="margin-top:8px">
          <div>
            <div class="list-header"><b>Bench</b><span class="badge" id="countBench">0</span></div>
            <div class="dropzone" id="zone-bench" data-team="-"></div>
          </div>
          <div>
            <div class="list-header"><b>Takƒ±m A</b><span class="badge" id="countA">0</span></div>
            <div class="dropzone" id="zone-A" data-team="A"></div>
          </div>
          <div>
            <div class="list-header"><b>Takƒ±m B</b><span class="badge" id="countB">0</span></div>
            <div class="dropzone" id="zone-B" data-team="B"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="card">
      <h2>Saha Yerle≈üimi</h2>
      <div class="content fieldwrap">
        <div class="split2">
          <div>
            <div class="field-title"><b>Takƒ±m A</b><span class="badge" id="hintA">0</span></div>
            <div class="field" id="fieldA"><div class="circle"></div></div>
          </div>
          <div>
            <div class="field-title"><b>Takƒ±m B</b><span class="badge" id="hintB">0</span></div>
            <div class="field" id="fieldB"><div class="circle"></div></div>
          </div>
        </div>
        <p class="pill" style="margin-top:8px">ƒ∞pucu: Karttaki <b>Rol</b> se√ßimine g√∂re yerle≈üim yapƒ±lƒ±r. Starter, Gol, Asist sahayƒ± etkilemez; raporda kullanƒ±lƒ±r.</p>
      </div>
    </section>
  </main>

  <!-- Sticky action dock (mobile-friendly) -->
  <div class="dock">
    <button class="cta" id="buildBtn">Sahaya Yerle≈ütir</button>
    <button class="ghost" id="newMatch">Yeni Ma√ß</button>
    <button class="cta" id="saveStats">Kaydet</button>
    <button class="ghost" id="exportCsv">CSV ƒ∞ndir</button>
  </div>

  <div id="toast" class="toast">Kaydedildi ‚úÖ</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    /* Firebase */
    const firebaseConfig = {
      apiKey: "AIzaSyCWzY5xWn1WYPCfeaQb4xqmJIy5oJnaiHk",
      authDomain: "tgshalisaha-1e266.firebaseapp.com",
      projectId: "tgshalisaha-1e266",
      storageBucket: "tgshalisaha-1e266.appspot.com",
      messagingSenderId: "829282473937",
      appId: "1:829282473937:web:bdf37a003cad53b763f2f0",
      measurementId: "G-4898506T9Z"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* Oyuncular */
    const PLAYERS = [
      {id:"tsubasa", name:"Tsubasa Ozora", img:"images/tsubasa.jpg"},
      {id:"hyuga", name:"Kojiro Hyuga", img:"images/hyuga.jpg"},
      {id:"misaki", name:"Taro Misaki", img:"images/misaki.jpg"},
      {id:"wakabayashi", name:"Genzo Wakabayashi", img:"images/wakabayashi.jpg"},
      {id:"wakashimazu", name:"Ken Wakashimazu", img:"images/wakashimazu.jpg"},
      {id:"matsuyama", name:"Hikaru Matsuyama", img:"images/matsuyama.jpg"},
      {id:"soda", name:"Makoto Soda", img:"images/soda.jpg"},
      {id:"tachibana", name:"Kazuo Tachibana", img:"images/tachibana.jpg"},
      {id:"takasugi", name:"Shingo Takasugi", img:"images/takasugi.jpg"},
      {id:"ishizaki", name:"Ryo Ishizaki", img:"images/ishizaki.jpg"},
      {id:"jun", name:"Jun Misugi", img:"images/jun.jpg"},
      {id:"nitta", name:"Shun Nitta", img:"images/nitta.jpg"},
      {id:"kisugi", name:"Seiichiro Kisugi", img:"images/kisugi2.jpg"},
      {id:"taki",   name:"Hajime Taki",     img:"images/taki.jpg"}
    ];

    /* Refs */
    const teamSizeSel = document.getElementById("teamSize");
    const autoSplitBtn = document.getElementById("autoSplit");
    const buildBtn = document.getElementById("buildBtn");
    const newMatchBtn = document.getElementById("newMatch");
    const saveStatsBtn = document.getElementById("saveStats");
    const exportCsvBtn = document.getElementById("exportCsv");
    const zoneBench = document.getElementById("zone-bench");
    const zoneA = document.getElementById("zone-A");
    const zoneB = document.getElementById("zone-B");
    const countBench = document.getElementById("countBench");
    const countA = document.getElementById("countA");
    const countB = document.getElementById("countB");
    const fieldA = document.getElementById("fieldA");
    const fieldB = document.getElementById("fieldB");
    const hintA = document.getElementById("hintA");
    const hintB = document.getElementById("hintB");
    const matchMeta = document.getElementById("matchMeta");
    const statusSpan = document.getElementById("status");
    const toast = document.getElementById("toast");

    /* Local state */
    const savedTeams = JSON.parse(localStorage.getItem("tg_teams") || "{}");
    const savedRoles = JSON.parse(localStorage.getItem("tg_roles") || "{}");
    const savedStats = JSON.parse(localStorage.getItem("tg_stats") || "{}");
    function setTeamFor(id, t){ savedTeams[id]=t; localStorage.setItem("tg_teams", JSON.stringify(savedTeams)); }
    function teamOf(id){ return savedTeams[id] ?? "-"; }
    function setRoleFor(id, r){ savedRoles[id]=r; localStorage.setItem("tg_roles", JSON.stringify(savedRoles)); }
    function roleOf(id){ return savedRoles[id] ?? "MID"; }
    function statsOf(id){ return savedStats[id] ?? {g:0,a:0,starter:false}; }
    function setStatsFor(id, s){ savedStats[id]=s; localStorage.setItem("tg_stats", JSON.stringify(savedStats)); }

    /* Field templates */
    const TEMPLATES = {
      5: [ {role:"GK",x:50,y:90},{role:"DEF",x:30,y:65},{role:"DEF",x:70,y:65},{role:"MID",x:40,y:40},{role:"FWD",x:60,y:25} ],
      6: [ {role:"GK",x:50,y:90},{role:"DEF",x:25,y:70},{role:"DEF",x:75,y:70},{role:"MID",x:35,y:48},{role:"MID",x:65,y:48},{role:"FWD",x:50,y:28} ],
      7: [ {role:"GK",x:50,y:90},{role:"DEF",x:20,y:70},{role:"DEF",x:50,y:70},{role:"DEF",x:80,y:70},{role:"MID",x:35,y:48},{role:"MID",x:65,y:48},{role:"FWD",x:50,y:28} ]
    };

    /* Match id */
    let matchId = localStorage.getItem("tg_matchId") || "";
    function ensureMatchId(){
      if(!matchId){ matchId = "m_" + Date.now(); localStorage.setItem("tg_matchId", matchId); }
      matchMeta.textContent = `Match: ${matchId}`;
    }
    ensureMatchId();

    let selected = []; // [{id,name,img,pickedBy,ts}]

    /* Listen picks */
    onSnapshot(collection(db, "tsubasa_picks"), (snap) => {
      const map = {}; snap.forEach(d => map[d.id] = d.data());
      selected = PLAYERS.filter(p => map[p.id]?.picked)
        .map(p => ({...p, pickedBy: map[p.id].pickedBy || "", ts: map[p.id].ts || 0}))
        .sort((a,b)=>(a.ts||0)-(b.ts||0));
      statusSpan.textContent = selected.length ? `Se√ßili oyuncu: ${selected.length}` : "Hen√ºz se√ßim yok";
      renderLists();
    });

    /* Drag & Drop */
    let dragId = null;
    [zoneBench, zoneA, zoneB].forEach(zone=>{
      zone.addEventListener("dragover", e=>{ e.preventDefault(); zone.classList.add("hover"); });
      zone.addEventListener("dragleave", ()=> zone.classList.remove("hover"));
      zone.addEventListener("drop", e=>{
        e.preventDefault(); zone.classList.remove("hover");
        if(dragId){ setTeamFor(dragId, zone.dataset.team); renderLists(); dragId = null; }
      });
    });

    function rolePill(role){
      const r = role || "MID";
      const cls = r==="GK"?"rp-gk":r==="DEF"?"rp-def":r==="MID"?"rp-mid":"rp-fwd";
      return `<span class="rolepill ${cls}">${r}</span>`;
    }

    function itemHtml(p){
      const t = teamOf(p.id);
      const st = statsOf(p.id);
      const r = roleOf(p.id);
      return `
        <div class="item" draggable="true" data-id="${p.id}">
          <div class="handle">‚†ø</div>
          <img class="thumb" src="${p.img}" alt="${p.name}" onerror="this.src='https://via.placeholder.com/120x90?text=${encodeURIComponent(p.name)}'">
          <div>
            <div class="meta">
              <span class="name">${p.name}</span>
              <span class="who">Se√ßen: ${p.pickedBy || "-"}</span>
              ${rolePill(r)}
              <span class="badge">Takƒ±m: <b>${t==="-"?"Bench":t}</b></span>
            </div>
            <div class="rowbot">
              <label class="who">Rol</label>
              <select data-ctl="role">
                <option value="GK"  ${r==="GK"?"selected":""}>GK</option>
                <option value="DEF" ${r==="DEF"?"selected":""}>DEF</option>
                <option value="MID" ${r==="MID"?"selected":""}>MID</option>
                <option value="FWD" ${r==="FWD"?"selected":""}>FWD</option>
              </select>

              <label class="who">Starter</label>
              <input data-ctl="starter" type="checkbox" ${st.starter?"checked":""} />

              <label class="who">Gol</label>
              <input data-ctl="g" class="num" type="number" min="0" max="30" value="${st.g||0}"/>

              <label class="who">Asist</label>
              <input data-ctl="a" class="num" type="number" min="0" max="30" value="${st.a||0}"/>
            </div>
          </div>
        </div>
      `;
    }

    function attachItemEvents(container){
      container.querySelectorAll(".item").forEach(el=>{
        const id = el.dataset.id;
        el.addEventListener("dragstart", ()=>{ dragId = id; el.classList.add("dragging"); });
        el.addEventListener("dragend", ()=> el.classList.remove("dragging"));
        const roleSel = el.querySelector('[data-ctl="role"]');
        const chk = el.querySelector('[data-ctl="starter"]');
        const g = el.querySelector('[data-ctl="g"]');
        const a = el.querySelector('[data-ctl="a"]');
        roleSel.addEventListener("change", e=>{ setRoleFor(id, e.target.value); renderLists(); });
        chk.addEventListener("change", e=> setStatsFor(id, {...statsOf(id), starter:e.target.checked}));
        g.addEventListener("change", e=> setStatsFor(id, {...statsOf(id), g:+e.target.value||0}));
        a.addEventListener("change", e=> setStatsFor(id, {...statsOf(id), a:+e.target.value||0}));
      });
    }

    function renderLists(){
      selected.forEach(p=>{ if(savedTeams[p.id]===undefined) setTeamFor(p.id, "-"); });
      const bench = selected.filter(p=>teamOf(p.id)==="-");
      const teamA = selected.filter(p=>teamOf(p.id)==="A");
      const teamB = selected.filter(p=>teamOf(p.id)==="B");

      zoneBench.innerHTML = bench.map(itemHtml).join("");
      zoneA.innerHTML = teamA.map(itemHtml).join("");
      zoneB.innerHTML = teamB.map(itemHtml).join("");

      attachItemEvents(zoneBench);
      attachItemEvents(zoneA);
      attachItemEvents(zoneB);

      countBench.textContent = bench.length;
      countA.textContent = teamA.length;
      countB.textContent = teamB.length;
      hintA.textContent = teamA.length;
      hintB.textContent = teamB.length;
    }

    /* Auto split */
    autoSplitBtn.addEventListener("click", ()=>{
      let toggle = true;
      selected.forEach(p=>{ setTeamFor(p.id, toggle?"A":"B"); toggle=!toggle; });
      renderLists();
    });

    /* Draw fields */
    function renderField(fieldEl, teamPlayers, teamSize){
      fieldEl.querySelectorAll(".pos").forEach(el=>el.remove());
      const tmpl = TEMPLATES[teamSize];
      const pool = teamPlayers.slice(0, teamSize);
      tmpl.forEach(slot=>{
        if(!pool.length) return;
        let idx = pool.findIndex(p => roleOf(p.id)===slot.role);
        if(idx < 0) idx = 0;
        const p = pool.splice(idx,1)[0];
        const node = document.createElement("div");
        node.className = "pos";
        node.style.left = slot.x+"%"; node.style.top = slot.y+"%";
        const role = roleOf(p.id);
        const tagClass = role==="GK"?"rp-gk":role==="DEF"?"rp-def":role==="MID"?"rp-mid":"rp-fwd";
        node.innerHTML = `
          <span class="tag ${tagClass}">${slot.role}</span>
          <img class="avatar" src="${p.img}" onerror="this.src='https://via.placeholder.com/160x110?text=${encodeURIComponent(p.name)}'">
          <div class="label">${p.name}</div>`;
        fieldEl.appendChild(node);
      });
    }

    function build(){
      const size = +teamSizeSel.value;
      const teamA = selected.filter(p=>teamOf(p.id)==="A");
      const teamB = selected.filter(p=>teamOf(p.id)==="B");
      hintA.textContent = teamA.length; hintB.textContent = teamB.length;
      renderField(fieldA, teamA, size);
      renderField(fieldB, teamB, size);
      showToast("Sahaya yerle≈ütirildi ‚öΩ");
    }
    buildBtn.addEventListener("click", build);

    /* Match ops */
    let matchId = localStorage.getItem("tg_matchId") || "";
    function resetStatsOnly(){
      localStorage.removeItem("tg_stats");
      Object.keys(savedStats).forEach(k=> delete savedStats[k]);
    }
    newMatchBtn.addEventListener("click", ()=>{
      matchId = "m_" + Date.now();
      localStorage.setItem("tg_matchId", matchId);
      resetStatsOnly();
      matchMeta.textContent = `Match: ${matchId}`;
      showToast("Yeni ma√ß olu≈üturuldu üÜï");
    });

    /* Save */
    async function saveToFirestore(){
      const teamSize = +teamSizeSel.value;
      await setDoc(doc(db, "matches", matchId), { createdAt: Date.now(), teamSize }, {merge:true});
      const writes = selected.map(p=>{
        const st = statsOf(p.id);
        const data = { name:p.name, img:p.img, team:teamOf(p.id), role:roleOf(p.id), starter:!!st.starter, g:st.g||0, a:st.a||0 };
        return setDoc(doc(db, "matches", matchId, "players", p.id), data, {merge:true});
      });
      await Promise.all(writes);
    }
    saveStatsBtn.addEventListener("click", async ()=>{
      try{ await saveToFirestore(); showToast("Kaydedildi ‚úÖ"); }catch{ showToast("Kaydedilemedi ‚ö†Ô∏è"); }
    });

    /* CSV */
    function toCsv(rows){
      const headers = ["playerId","name","team","role","starter","goals","assists"];
      const lines = [headers.join(",")];
      rows.forEach(r=> lines.push([r.id, `"${r.name}"`, r.team, r.role, r.starter?1:0, r.g, r.a].join(",")));
      return lines.join("\n");
    }
    exportCsvBtn.addEventListener("click", ()=>{
      const rows = selected.map(p=>{
        const st = statsOf(p.id);
        return { id:p.id, name:p.name, team:teamOf(p.id), role:roleOf(p.id), starter:!!st.starter, g:st.g||0, a:st.a||0 };
      });
      const blob = new Blob([toCsv(rows)], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href=url; a.download=`match_${matchId||"current"}.csv`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      showToast("CSV indirildi ‚¨áÔ∏è");
    });

    /* toast */
    function showToast(msg){
      toast.textContent = msg;
      toast.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.style.display="none", 1600);
    }
  </script>
</body>
</html>
