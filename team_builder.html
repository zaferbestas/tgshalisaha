<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Toprak G√ºbre Su Halƒ±saha ‚Äì Takƒ±m & Ma√ß Y√∂netimi</title>
  <meta name="theme-color" content="#0b1530">
  <style>
    :root{ --bg1:#0b1530; --bg2:#0e223f; --panel:#111c36; --panel-2:#0f1a31;
      --accent:#27e0a5; --text:#e9f2ff; --muted:#a7bbd6; --line:#1f3557; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);
      background: radial-gradient(1200px 500px at 50% -10%, rgba(28,64,112,.55), rgba(28,64,112,0) 60%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));}
    header{position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:10px;justify-content:space-between;
      padding:14px 16px;background:linear-gradient(180deg, rgba(6,14,33,.9), rgba(6,14,33,.75));
      border-bottom:1px solid rgba(96,165,250,.18);backdrop-filter: blur(6px);}
    h1{margin:0;font-size:clamp(18px,2.6vw,22px)}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid rgba(96,165,250,.25);
      background:linear-gradient(180deg,var(--panel),var(--panel-2));padding:8px 10px;border-radius:999px;font-size:12px;color:#cfe2ff;}
    main{max-width:1200px;margin:16px auto 80px;padding:0 16px;}
    .grid{display:grid;gap:16px;grid-template-columns:1.15fr 1fr}
    @media (max-width:1050px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(160deg,#0f1d3a 0%,#0b1530 100%);border:1px solid rgba(96,165,250,.15);
      border-radius:14px;overflow:hidden;box-shadow:0 16px 32px rgba(0,0,0,.35);}
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--line);font-size:16px}
    .content{padding:14px 16px}
    .actions{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;align-items:center}
    button, select, input[type="number"]{
      padding:8px 10px;border-radius:10px;border:1px solid #274b6a;background:#0e2235;color:#cfe6ff;font-weight:600;cursor:pointer}
    button.cta{background:var(--accent);color:#031a15;border:none;box-shadow:0 10px 22px rgba(39,224,165,.35)}
    .list{display:grid;gap:10px}
    .row{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;border:1px solid var(--line);
      border-radius:10px;padding:8px 10px;background:#0e203a}
    .row img{width:52px;height:40px;object-fit:cover;border-radius:8px;border:1px solid var(--line)}
    .small{font-size:12px;color:var(--muted)}
    .ctrls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:flex-end}
    .num{width:64px}
    .fieldwrap{display:grid;gap:14px}
    .field{position:relative;aspect-ratio:2/3;border-radius:18px;background:linear-gradient(180deg,#0e2b17,#0a1c0f);
      border:1px solid #2f5641;padding:10px}
    .field::before,.field::after{content:"";position:absolute;left:50%;transform:translateX(-50%);border:2px solid rgba(255,255,255,.25);}
    .field::before{top:8%;width:70%;height:26%;border-radius:12px}
    .field::after{bottom:8%;width:70%;height:26%;border-radius:12px}
    .circle{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:26%;height:16%;border-radius:999px;border:2px solid rgba(255,255,255,.25)}
    .field-title{display:flex;align-items:center;justify-content:space-between}
    .pos{position:absolute;translate:-50% -50%;display:grid;place-items:center;gap:4px;text-align:center}
    .badge{font-size:10px;padding:2px 6px;border-radius:999px;background:#102f23;color:#b9ffe7;border:1px solid rgba(39,224,165,.35)}
    .avatar{width:60px;height:46px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,.2)}
    .label{font-size:11px}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:700px){.split{grid-template-columns:1fr}}
    .muted{color:#a7bbd6}
    .spacer{flex:1}
  </style>
</head>
<body>
  <header>
    <h1>Toprak G√ºbre Su Halƒ±saha ‚Äì Takƒ±m & Ma√ß Y√∂netimi</h1>
    <div class="pill">üì° Se√ßimler canlƒ± ‚Ä¢ ‚úçÔ∏è Roller & ƒ∞statistikler d√ºzenlenebilir</div>
  </header>

  <main class="grid">
    <!-- LEFT: roster & controls -->
    <section class="card">
      <h2>Kadro / Se√ßimler</h2>
      <div class="content">
        <div class="actions">
          <label class="small">Takƒ±m boyutu (her takƒ±m):</label>
          <select id="teamSize">
            <option value="5">5</option>
            <option value="6" selected>6</option>
            <option value="7">7</option>
          </select>
          <button id="autoSplit" title="Oyuncularƒ± sƒ±rayla A/B'ye daƒüƒ±t">Oto-b√∂l A/B</button>
          <div class="spacer"></div>
          <button id="newMatch">Yeni Ma√ß</button>
          <button class="cta" id="saveStats">Kaydet</button>
          <button id="exportCsv">CSV ƒ∞ndir</button>
        </div>
        <div class="small muted" id="matchMeta">Match: (olu≈üturuluyor‚Ä¶)</div>
        <div class="actions">
          <span class="small">Toplu rol:</span>
          <button data-setall="GK">GK</button>
          <button data-setall="DEF">DEF</button>
          <button data-setall="MID">MID</button>
          <button data-setall="FWD">FWD</button>
        </div>
        <div id="selectedList" class="list"></div>
      </div>
    </section>

    <!-- RIGHT: two fields -->
    <section class="card">
      <h2>Saha Yerle≈üimi</h2>
      <div class="content fieldwrap">
        <div class="split">
          <div>
            <div class="field-title"><b>Takƒ±m A</b><span class="small muted" id="countA"></span></div>
            <div class="field" id="fieldA"><div class="circle"></div></div>
          </div>
          <div>
            <div class="field-title"><b>Takƒ±m B</b><span class="small muted" id="countB"></span></div>
            <div class="field" id="fieldB"><div class="circle"></div></div>
          </div>
        </div>
        <div class="actions">
          <button class="cta" id="buildBtn">Sahaya Yerle≈ütir</button>
          <span class="small muted">Rol & takƒ±m se√ßimlerini soldan yapƒ±n. Starter i≈üaretleyin, gol/asist girin. ‚ÄúKaydet‚Äù t√ºm√ºn√º Firestore‚Äôa yazar.</span>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, setDoc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCWzY5xWn1WYPCfeaQb4xqmJIy5oJnaiHk",
      authDomain: "tgshalisaha-1e266.firebaseapp.com",
      projectId: "tgshalisaha-1e266",
      storageBucket: "tgshalisaha-1e266.appspot.com",
      messagingSenderId: "829282473937",
      appId: "1:829282473937:web:bdf37a003cad53b763f2f0",
      measurementId: "G-4898506T9Z"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Players (14)
    const PLAYERS = [
      {id:"tsubasa", name:"Tsubasa Ozora", img:"images/tsubasa.jpg"},
      {id:"hyuga", name:"Kojiro Hyuga", img:"images/hyuga.jpg"},
      {id:"misaki", name:"Taro Misaki", img:"images/misaki.jpg"},
      {id:"wakabayashi", name:"Genzo Wakabayashi", img:"images/wakabayashi.jpg"},
      {id:"wakashimazu", name:"Ken Wakashimazu", img:"images/wakashimazu.jpg"},
      {id:"matsuyama", name:"Hikaru Matsuyama", img:"images/matsuyama.jpg"},
      {id:"soda", name:"Makoto Soda", img:"images/soda.jpg"},
      {id:"tachibana", name:"Kazuo Tachibana", img:"images/tachibana.jpg"},
      {id:"takasugi", name:"Shingo Takasugi", img:"images/takasugi.jpg"},
      {id:"ishizaki", name:"Ryo Ishizaki", img:"images/ishizaki.jpg"},
      {id:"jun", name:"Jun Misugi", img:"images/jun.jpg"},
      {id:"nitta", name:"Shun Nitta", img:"images/nitta.jpg"},
      {id:"kisugi", name:"Seiichiro Kisugi", img:"images/kisugi2.jpg"},
      {id:"taki",   name:"Hajime Taki",     img:"images/taki.jpg"}
    ];

    // UI refs
    const selList = document.getElementById("selectedList");
    const statusSpan = document.getElementById("status");
    const teamSizeSel = document.getElementById("teamSize");
    const buildBtn = document.getElementById("buildBtn");
    const autoSplitBtn = document.getElementById("autoSplit");
    const newMatchBtn = document.getElementById("newMatch");
    const saveStatsBtn = document.getElementById("saveStats");
    const exportCsvBtn = document.getElementById("exportCsv");
    const fieldA = document.getElementById("fieldA");
    const fieldB = document.getElementById("fieldB");
    const countA = document.getElementById("countA");
    const countB = document.getElementById("countB");
    const matchMeta = document.getElementById("matchMeta");

    // Local role/team store for UI (shared across users only after Save -> Firestore)
    const savedRoles = JSON.parse(localStorage.getItem("tg_roles") || "{}");
    const savedTeams = JSON.parse(localStorage.getItem("tg_teams") || "{}");
    const savedStats = JSON.parse(localStorage.getItem("tg_stats") || "{}"); // {playerId:{g,a,starter}}

    function getRoleFor(id){ return savedRoles[id] || "MID"; }
    function setRoleFor(id, role){ savedRoles[id]=role; localStorage.setItem("tg_roles", JSON.stringify(savedRoles)); }
    function getTeamFor(id){ return savedTeams[id] || "A"; }
    function setTeamFor(id, t){ savedTeams[id]=t; localStorage.setItem("tg_teams", JSON.stringify(savedTeams)); }
    function getStatsFor(id){ return savedStats[id] || {g:0,a:0,starter:false}; }
    function setStatsFor(id, s){ savedStats[id]=s; localStorage.setItem("tg_stats", JSON.stringify(savedStats)); }

    // Field templates per team
    const TEMPLATES = {
      5: [ {role:"GK",x:50,y:90},{role:"DEF",x:30,y:65},{role:"DEF",x:70,y:65},{role:"MID",x:40,y:40},{role:"FWD",x:60,y:25} ],
      6: [ {role:"GK",x:50,y:90},{role:"DEF",x:25,y:70},{role:"DEF",x:75,y:70},{role:"MID",x:35,y:48},{role:"MID",x:65,y:48},{role:"FWD",x:50,y:28} ],
      7: [ {role:"GK",x:50,y:90},{role:"DEF",x:20,y:70},{role:"DEF",x:50,y:70},{role:"DEF",x:80,y:70},{role:"MID",x:35,y:48},{role:"MID",x:65,y:48},{role:"FWD",x:50,y:28} ]
    };

    let selected = []; // [{id,name,img,pickedBy,ts}]

    // current match id (shared for stats)
    let matchId = localStorage.getItem("tg_matchId") || "";
    function ensureMatchId(){
      if(!matchId){
        matchId = "m_" + Date.now();
        localStorage.setItem("tg_matchId", matchId);
      }
      matchMeta.textContent = `Match ID: ${matchId}`;
    }
    ensureMatchId();

    // Live picks feed
    onSnapshot(collection(db, "tsubasa_picks"), (snap) => {
      const map = {};
      snap.forEach(d => { map[d.id] = d.data(); });
      selected = PLAYERS.filter(p => map[p.id]?.picked)
        .map(p => ({...p, pickedBy: map[p.id].pickedBy || "", ts: map[p.id].ts || 0}))
        .sort((a,b)=>(a.ts||0)-(b.ts||0));
      renderList();
      const info = document.getElementById("status");
      if(info) info.textContent = selected.length ? `Se√ßili oyuncu: ${selected.length}` : "Hen√ºz se√ßim yok";
    });

    // Render roster with role/team/stats controls
    function rowHtml(p){
      const role = getRoleFor(p.id);
      const team = getTeamFor(p.id);
      const st = getStatsFor(p.id);
      return `
        <div class="row" id="row-${p.id}">
          <img src="${p.img}" alt="${p.name}"
               onerror="this.src='https://via.placeholder.com/120x90?text=${encodeURIComponent(p.name)}'">
          <div>
            <div><b>${p.name}</b></div>
            <div class="small">Se√ßen: ${p.pickedBy || "-"}</div>
          </div>
          <div class="ctrls">
            <label class="small">Rol</label>
            <select id="role-${p.id}">
              <option value="GK"  ${role==="GK"?"selected":""}>GK</option>
              <option value="DEF" ${role==="DEF"?"selected":""}>DEF</option>
              <option value="MID" ${role==="MID"?"selected":""}>MID</option>
              <option value="FWD" ${role==="FWD"?"selected":""}>FWD</option>
            </select>

            <label class="small">Takƒ±m</label>
            <select id="team-${p.id}">
              <option value="A" ${team==="A"?"selected":""}>A</option>
              <option value="B" ${team==="B"?"selected":""}>B</option>
              <option value="-" ${team==="-"?"selected":""}>Bench</option>
            </select>

            <label class="small">Starter</label>
            <input type="checkbox" id="st-${p.id}" ${st.starter?"checked":""} />

            <label class="small">Gol</label>
            <input class="num" type="number" min="0" max="20" id="g-${p.id}" value="${st.g||0}"/>

            <label class="small">Asist</label>
            <input class="num" type="number" min="0" max="20" id="a-${p.id}" value="${st.a||0}"/>
          </div>
        </div>
      `;
    }

    function renderList(){
      selList.innerHTML = selected.map(rowHtml).join("");
      // attach listeners
      selected.forEach(p=>{
        const r = document.getElementById(`role-${p.id}`);
        const t = document.getElementById(`team-${p.id}`);
        const sg = document.getElementById(`g-${p.id}`);
        const sa = document.getElementById(`a-${p.id}`);
        const st = document.getElementById(`st-${p.id}`);
        r.addEventListener("change", e=> setRoleFor(p.id, e.target.value));
        t.addEventListener("change", e=> setTeamFor(p.id, e.target.value));
        sg.addEventListener("change", e=> setStatsFor(p.id, {...getStatsFor(p.id), g:+e.target.value||0}));
        sa.addEventListener("change", e=> setStatsFor(p.id, {...getStatsFor(p.id), a:+e.target.value||0}));
        st.addEventListener("change", e=> setStatsFor(p.id, {...getStatsFor(p.id), starter: e.target.checked}));
      });
    }

    // Bulk set roles
    document.querySelectorAll("[data-setall]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const role = btn.getAttribute("data-setall");
        selected.forEach(p=>{
          setRoleFor(p.id, role);
          const el = document.getElementById(`role-${p.id}`);
          if(el) el.value = role;
        });
      });
    });

    // Auto split A/B alternating
    autoSplitBtn.addEventListener("click", ()=>{
      let toggle = true;
      selected.forEach(p=>{
        const team = toggle ? "A" : "B";
        setTeamFor(p.id, team);
        const el = document.getElementById(`team-${p.id}`);
        if(el) el.value = team;
        toggle = !toggle;
      });
    });

    // Layout logic
    function renderField(fieldEl, teamPlayers, teamSize){
      fieldEl.querySelectorAll(".pos").forEach(el=>el.remove());
      const tmpl = TEMPLATES[teamSize];
      const pool = teamPlayers.slice(0, teamSize); // cap by size
      tmpl.forEach(slot=>{
        if(!pool.length) return;
        let idx = pool.findIndex(p => p.role===slot.role);
        if(idx < 0) idx = 0;
        const p = pool.splice(idx,1)[0];
        const el=document.createElement("div");
        el.className="pos";
        el.style.left=slot.x+"%"; el.style.top=slot.y+"%";
        el.innerHTML = `
          <span class="badge">${slot.role}</span>
          <img class="avatar" src="${p.img}" onerror="this.src='https://via.placeholder.com/160x110?text=${encodeURIComponent(p.name)}'">
          <div class="label">${p.name}</div>`;
        fieldEl.appendChild(el);
      });
    }

    function build(){
      const size = +teamSizeSel.value;
      const teamA = selected
        .filter(p => getTeamFor(p.id)==="A")
        .map(p => ({...p, role: getRoleFor(p.id)}));
      const teamB = selected
        .filter(p => getTeamFor(p.id)==="B")
        .map(p => ({...p, role: getRoleFor(p.id)}));
      countA.textContent = `${teamA.length} oyuncu`;
      countB.textContent = `${teamB.length} oyuncu`;
      renderField(fieldA, teamA, size);
      renderField(fieldB, teamB, size);
    }
    buildBtn.addEventListener("click", build);

    // Match ops
    newMatchBtn.addEventListener("click", async ()=>{
      matchId = "m_" + Date.now();
      localStorage.setItem("tg_matchId", matchId);
      // Clear local stats for a clean slate
      localStorage.removeItem("tg_stats");
      Object.keys(savedStats).forEach(k=> delete savedStats[k]);
      matchMeta.textContent = `Match ID: ${matchId}`;
      alert("Yeni ma√ß olu≈üturuldu.");
    });

    // Save to Firestore
    saveStatsBtn.addEventListener("click", async ()=>{
      if(!matchId) ensureMatchId();
      const teamSize = +teamSizeSel.value;
      // save match meta
      await setDoc(doc(db, "matches", matchId), {
        createdAt: Date.now(),
        teamSize,
      }, {merge:true});
      // save each player
      const promises = selected.map(p=>{
        const data = {
          name: p.name,
          img: p.img,
          role: getRoleFor(p.id),
          team: getTeamFor(p.id),
          ...getStatsFor(p.id)
        };
        return setDoc(doc(db, "matches", matchId, "players", p.id), data, {merge:true});
      });
      await Promise.all(promises);
      alert("Kaydedildi ‚úÖ");
    });

    // Export CSV
    function toCsv(rows){
      const headers = ["playerId","name","team","role","starter","goals","assists"];
      const lines = [headers.join(",")];
      rows.forEach(r=>{
        lines.push([r.id, `"${r.name}"`, r.team, r.role, r.starter?1:0, r.g, r.a].join(","));
      });
      return lines.join("\n");
    }
    exportCsvBtn.addEventListener("click", async ()=>{
      const rows = selected.map(p=>{
        const st = getStatsFor(p.id);
        return {id:p.id, name:p.name, team:getTeamFor(p.id), role:getRoleFor(p.id), starter:!!st.starter, g:st.g||0, a:st.a||0};
      });
      const blob = new Blob([toCsv(rows)], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `match_${matchId||"current"}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
